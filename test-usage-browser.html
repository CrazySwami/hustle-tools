<!DOCTYPE html>
<html>
<head>
  <title>Usage Tracking Test</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-bottom: 20px; }
    #output { white-space: pre-wrap; background: #000; padding: 10px; border: 1px solid #0f0; }
    .success { color: #0f0; }
    .error { color: #f00; }
    .info { color: #00f; }
  </style>
</head>
<body>
  <h1>🧪 Usage Tracking Test</h1>
  <button onclick="testUsageTracking()">Test Chat API</button>
  <button onclick="clearOutput()">Clear</button>
  <div id="output"></div>

  <script>
    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const color = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      output.innerHTML += `<span class="${color}">${message}</span>\n`;
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '';
    }

    async function testUsageTracking() {
      clearOutput();
      log('🧪 Starting usage tracking test...', 'info');
      log('Sending POST to http://localhost:3002/api/chat-elementor\n', 'info');

      try {
        const response = await fetch('http://localhost:3002/api/chat-elementor', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            messages: [{
              id: 'test' + Date.now(),
              role: 'user',
              parts: [{
                type: 'text',
                text: 'say hello'
              }]
            }],
            model: 'anthropic/claude-haiku-4-5-20251001',
          })
        });

        log(`Status: ${response.status}`, response.ok ? 'success' : 'error');

        if (!response.ok) {
          const text = await response.text();
          log(`Error: ${text}`, 'error');
          return;
        }

        // Parse stream
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let metadataFound = false;
        let finishChunkFound = false;
        let messageData = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') {
                log('\n📍 Stream ended: [DONE]', 'info');
                continue;
              }

              try {
                const json = JSON.parse(data);

                // Log chunk type
                if (json.type) {
                  log(`📦 Chunk type: ${json.type}`, 'info');
                }

                // Look for finish chunk
                if (json.type === 'finish') {
                  finishChunkFound = true;
                  log('\n✅ FINISH CHUNK FOUND!', 'success');
                  log(`Finish data: ${JSON.stringify(json, null, 2)}`, 'success');
                }

                // Look for message with metadata
                if (json.type === 'message-start' || json.type === 'message') {
                  messageData = json;
                  if (json.metadata) {
                    metadataFound = true;
                    log('\n✅ METADATA FOUND IN MESSAGE!', 'success');
                    log(`Metadata: ${JSON.stringify(json.metadata, null, 2)}`, 'success');
                  }
                }

                // Also check for metadata in any chunk
                if (json.metadata && !metadataFound) {
                  metadataFound = true;
                  log('\n✅ METADATA FOUND!', 'success');
                  log(`Metadata: ${JSON.stringify(json.metadata, null, 2)}`, 'success');
                }
              } catch (e) {
                // Not JSON, skip
              }
            }
          }
        }

        log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
        log('📊 RESULTS:', 'info');
        log(`Finish chunk found: ${finishChunkFound ? '✅ YES' : '❌ NO'}`, finishChunkFound ? 'success' : 'error');
        log(`Metadata found: ${metadataFound ? '✅ YES' : '❌ NO'}`, metadataFound ? 'success' : 'error');

        if (messageData) {
          log(`\n📝 Final message data:`, 'info');
          log(JSON.stringify(messageData, null, 2), 'info');
        }

      } catch (error) {
        log(`\n❌ ERROR: ${error.message}`, 'error');
        console.error(error);
      }
    }
  </script>
</body>
</html>
